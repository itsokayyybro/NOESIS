<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module {{ checkpoint_id + 1 }} | Noesis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="ambient-bg">
        <div class="gradient-orb orb-2"></div>
    </div>

    <div class="editor-container">
        <!-- Top Navigation -->
        <nav class="editor-nav">
            <a href="{{ url_for('view_checkpoints', session_id=session_id) }}" class="nav-back">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Path
            </a>
            <div class="progress-indicator">
                <span class="progress-text">Module {{ checkpoint_id + 1 }} of {{ total_checkpoints }}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ ((checkpoint_id + 1) / total_checkpoints * 100)|int }}%"></div>
                </div>
            </div>
        </nav>

        <!-- Module Header -->
        <header class="module-header">
            <div class="module-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                Checkpoint {{ checkpoint_id + 1 }}
            </div>
            <h1>{{ checkpoint.title }}</h1>
        </header>

        <div class="editor-layout">
            <!-- Instructions Panel -->
            <div class="instructions-panel">
                <div class="panel-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <h3>Objective</h3>
                    </div>
                    <p>{{ checkpoint.objective }}</p>
                </div>

                <div class="panel-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                        <h3>Concept</h3>
                    </div>
                    <p>{{ checkpoint.concept }}</p>
                </div>

                <div class="panel-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16 18 22 12 16 6"></polyline>
                            <polyline points="8 6 2 12 8 18"></polyline>
                        </svg>
                        <h3>Signature</h3>
                    </div>
                    <div class="code-signature">
                        <code>{{ checkpoint.function_signature }}</code>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <h3>Requirements</h3>
                    </div>
                    <ul class="requirements-list">
                        {% for rule in checkpoint.rules %}
                        <li>{{ rule }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="panel-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        <h3>Expected Output</h3>
                    </div>
                    <p>{{ checkpoint.expected_output }}</p>
                </div>

                {% if checkpoint.hints %}
                <div class="panel-section hints-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <h3>Hints</h3>
                    </div>
                    <ul class="hints-list">
                        {% for hint in checkpoint.hints %}
                        <li>{{ hint }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Code Panel -->
            <div class="code-panel">
                <div class="code-toolbar">
                    <div class="toolbar-left">
                        <span class="file-indicator">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            solution.py
                        </span>
                    </div>
                    <button id="submit-btn" class="run-button">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Run Code
                    </button>
                </div>

                <div class="code-editor">
                    <textarea id="code-editor" 
                              spellcheck="false"
                              placeholder="# Write your solution here...">{{ previous_code }}</textarea>

                    <div id="validation-result" class="validation-result hidden">
                        <div class="result-header">
                            <span class="result-icon"></span>
                            <span class="result-title"></span>
                        </div>
                        <p class="result-message"></p>
                        <div class="result-details"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sessionId = '{ session_id }';
        const checkpointId = { checkpoint_id };

        document.getElementById('submit-btn').addEventListener('click', async () => {
            const code = document.getElementById('code-editor').value;
            const submitBtn = document.getElementById('submit-btn');
            const resultDiv = document.getElementById('validation-result');
            const iconSpan = resultDiv.querySelector('.result-icon');
            const titleSpan = resultDiv.querySelector('.result-title');
            const msgP = resultDiv.querySelector('.result-message');
            const detailsDiv = resultDiv.querySelector('.result-details');

            if (!code.trim()) {
                alert('Please write some code first');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg> Running...';
            resultDiv.classList.add('hidden');
            resultDiv.classList.remove('success', 'failure');

            try {
                const response = await fetch('/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        checkpoint_id: checkpointId,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                resultDiv.classList.remove('hidden');
                if (data.pass) {
                    resultDiv.classList.add('success');
                    iconSpan.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
                    titleSpan.textContent = 'All Tests Passed!';
                    msgP.textContent = data.message;
                    detailsDiv.innerHTML = '<a href="/checkpoints/' + sessionId + '" class="btn-primary" style="margin-top: 12px;">Continue to Next Module â†’</a>';
                } else {
                    resultDiv.classList.add('failure');
                    iconSpan.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
                    titleSpan.textContent = 'Tests Failed';
                    msgP.textContent = data.message;
                    if (data.details) {
                        detailsDiv.innerHTML = '<pre>' + data.details + '</pre>';
                    }
                }

            } catch (err) {
                console.error(err);
                resultDiv.classList.remove('hidden');
                resultDiv.classList.add('failure');
                iconSpan.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
                titleSpan.textContent = 'Error';
                msgP.textContent = 'Failed to validate code. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Run Code';
            }
        });
    </script>
</body>
</html>